
@{
    ViewBag.Title = "VisualizarHistoricoCancelados";
    Layout = "~/Views/MasterPage.cshtml";
}

<div class="col-sm-12">
    <div class="x_panel">
        <div class="x_title">
            <h2 class="tr" key="historicoresultados">Ver historicos contenedores cancelados</h2>
            <div class="clearfix"></div>
        </div>
        <div class="x_content">
            <div class="x_panel">
                <div class="x_title">
                    <h2 class="tr" key="filtrofechas">Filtro de Fechas</h2>
                    <div class="clearfix"></div>
                </div>
                <div class="row">
                    <div class="col-lg-9">
                        <form class="form-inline">
                            <div class="form-group">
                                <select class="selectpicker form-control" data-live-search="true" id="Tipo_busqueda">
                                    <option value="0" class="tr" key="filtrarpor">FILTER BY ...</option>
                                    <option value="1" class="tr" key="filtrarcrear">DATE CANCELLED CONTAINER</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="Fecha_inicio" class="control-label tr" key="fechainicio">Fecha Inicio</label>
                                <input type="text" autocomplete="off" class="form-control" id="Fecha_inicio" />
                            </div>
                            <div class="form-group">
                                <label for="Fecha_termino" class="control-label tr" key="entre">Entre</label>
                                <input type="text" autocomplete="off" class="form-control" id="Fecha_termino" />
                            </div>
                        </form>
                    </div>
                    <div class="col-lg-3">
                        <button class="btn btn-primary tr" key="filtrar" id="FiltroFechas">Filtrar</button>
                        <button class="btn btn-warning tr" key="limpiar" id="Limpiar">Limpiar</button>
                    </div>
                </div>
            </div>
            <div class="x_panel">
                <table id="Tb_Contenedores" class="table table-striped table-bordered display nowrap" width="100%">
                    <thead>
                        <tr>
                            <th class="tr" key="idcontainer">ID CONTAINER</th>
                            <th class="tr" key="contenedortabla">CONTAINER</th>
                            <th class="tr" key="FechaCancelado">FECHA CANCELADO</th>
                        </tr>
                    </thead>
                    <tfoot>
                        <tr>
                            <th class="tr" key="idcontainer">ID CONTAINER</th>
                            <th class="tr" key="contenedortabla">CONTAINER</th>
                            <th class="tr" key="FechaCancelado">FECHA CANCELADO</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {

        var lenguaje = document.cookie;


        $('#Tb_Contenedores tfoot th').each(function (i) {
            var title = $('#Tb_Contenedores thead th').eq($(this).index()).text();
            if (lenguaje == "es") {
                $(this).html('<input class="form-control" type="text" placeholder="BUSCAR" />');
            } else {
                $(this).html('<input class="form-control" type="text" placeholder="SEARCH" />');

            }
        });

        $.ajax({
            type: "POST",
            data: { Estado: $("#Estado").val() },
            url: '@Url.Action("GetContenedoresCancelados", "Contenedores")',
            success: function (response) {
                var data = [];
                var json = JSON.parse(response);
                var cuenta = json.length;
                for (var i = 0 ; i < cuenta ; i++) {

                    data.push([json[i].IdContenedor, json[i].NumeroContenedor, formatDate(json[i].Fecha)]);

                }

                var table = $('#Tb_Contenedores').DataTable({
                    data: data,
                    dom: 'Bfrtip',
                    buttons: [
                        'copy', 'csv', 'excel'
                    ],
                    scrollX: true
                });


                table.columns().every(function () {
                    var that = this;

                    $('input', this.footer()).on('keyup change', function () {
                        if (that.search() !== this.value) {
                            that
                                .search(this.value)
                                .draw();
                        }
                    });
                });
            },
        });

        if (lenguaje == "es") {
            $("#Fecha_termino, #Fecha_inicio").datepicker({
                dateFormat: "dd-mm-yy",
                firstDay: 1,
                dayNamesMin: ["Do", "Lu", "Ma", "Mi", "Ju", "Vi", "Sa"],
                dayNamesShort: ["Dom", "Lun", "Mar", "Mie", "Jue", "Vie", "Sab"],
                monthNames:
                    ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio",
                    "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"],
                monthNamesShort:
                    ["Ene", "Feb", "Mar", "Abr", "May", "Jun",
                    "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"],
                showWeek: true
            });
        } else {
            $("#Fecha_termino, #Fecha_inicio").datepicker({
                dateFormat: "dd-mm-yy",
                firstDay: 1,
                showWeek: true
            });
        }

        $("#FiltroFechas").click(function () {
            var table = $('#Tb_Contenedores').DataTable();
            table.destroy();

            if ($("#Tipo_busqueda").val() != "0" && $("#Fecha_inicio").val() != "" && $("#Fecha_termino").val() != "") {
                var fechainicio = new Date($('#Fecha_inicio').val()).getTime();
                var fechatermino = new Date($('#Fecha_termino').val()).getTime();
                if (fechatermino < fechainicio) {
                    if (lenguaje == "es") {
                        swal('Ups!', 'La fecha final no puede ser menor a la fecha inicial.', 'warning');
                        return false;
                    } else {
                        swal('Ups!', 'The final date can not be less than the initial date.', 'warning');
                        return false;
                    }
                }

                $.ajax({
                    type: "POST",
                    url: '@Url.Action("FiltroPorFechasCancelados", "Contenedores")',
                    data: { Tipo: $("#Tipo_busqueda").val(), FechaIni: $("#Fecha_inicio").val(), FechaFin: $("#Fecha_termino").val() },
                    success: function (response) {
                        var data = [];
                        var json = JSON.parse(response);
                        var cuenta = json.length;
                        for (var i = 0 ; i < cuenta ; i++) {
                            data.push([json[i].IdContenedor, json[i].NumeroContenedor, formatDate(json[i].Fecha)]);
                        }

                        var table = $('#Tb_Contenedores').DataTable({
                            data: data,
                            dom: 'Bfrtip',
                            buttons: [
                                'copy', 'csv', 'excel'
                            ],
                            scrollX: true
                        });


                        table.columns().every(function () {
                            var that = this;
                            $('input', this.footer()).on('keyup change', function () {
                                if (that.search() !== this.value) {
                                    that
                                        .search(this.value)
                                        .draw();
                                }
                            });
                        });
                    },
                });
            } else {
                swal('Ups!', '<span class="alerta" key="errorfiltrarsolicitud">Debe completar el formulario para filtrar las solicitudes.</span>', 'warning');
            }

        });


        $("#Limpiar").click(function () {
            location.reload();
        });

    });



    function formatDate(date) {
        var fecha = date.substring(0, 10);
        var ano = date.substring(0, 4);
        var mes = date.substring(5, 7);
        var dia = date.substring(8, 10);
        return dia + "-" + mes + "-" + ano;
    }

</script>