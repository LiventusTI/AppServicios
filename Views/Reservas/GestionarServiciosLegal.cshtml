@{
    ViewBag.Title = "GestionarServiciosLegal";
    Layout = "~/Views/MasterPage.cshtml";
    int PerfilInterior = Convert.ToInt32(Session["PerfilInterior"]);
    string Usuario = Session["User"].ToString().ToUpper();
}

<div class="col-sm-12">
    <div class="x_panel">
        <div class="x_title">
            <div class="row">
                <div class="col-sm-7">
                    <h2 class="tr" key="historicoservicios">Gestionar Servicios Legal</h2>
                </div>
            </div>
            <div class="clearfix"></div>
        </div>
        <div class="x_content">
            <div class="x_panel">
                <div class="col-sm-12 col-md-12 col-lg-12">
                    <table id="Tb_Servicios" class="table table-striped table-bordered display nowrap">
                        <thead>
                            <tr>
                                <th>GRAFICO</th>
                                <th>ESTADO APROBACION</th>
                                <th>FECHA ULT. ACCION</th>
                                <th>BOOKING</th>
                                <th>NAVIERA</th>
                                <th>NAVE</th>
                                <th>VIAJE</th>
                                <th>EXPORTADOR</th>
                                <th>COMMODITY</th>
                                <th>SETPOINT</th>
                                <th>PUERTO ORIGEN</th>
                                <th>PUERTO DESTINO</th>
                                <th>ETA</th>
                                <th>N° CONTENEDOR</th>
                                <th>CONTROLADOR</th>
                                <th>MODEM</th>
                                <th>FECHA SERVICIO</th>
                                <th>ESTADO SERVICIO</th>
                                <th>TEMPERATURA</th>
                                <th>ID SERVICIO</th>
                            </tr>
                            <tr>
                                <th></th>
                                <th>ESTADO APROBACION</th>
                                <th>FECHA ULT. ACCION</th>
                                <th>BOOKING</th>
                                <th>NAVIERA</th>
                                <th>ULTIMA NAVE</th>
                                <th>VIAJE</th>
                                <th>EXPORTADOR</th>
                                <th>COMMODITY</th>
                                <th>SETPOINT</th>
                                <th>PUERTO ORIGEN</th>
                                <th>PUERTO DESTINO</th>
                                <th>ETA</th>
                                <th>N° CONTENEDOR</th>
                                <th>CONTROLADOR</th>
                                <th>MODEM</th>
                                <th>FECHA SERVICIO</th>
                                <th>ESTADO SERVICIO</th>
                                <th>TEMPERATURA</th>
                                <th>ID SERVICIO</th>
                            </tr>
                        </thead>
                        <tfoot>
                            <tr>
                                <th></th>
                                <th>ESTADO APROBACION</th>
                                <th>FECHA ULT. ACCION</th>
                                <th>BOOKING</th>
                                <th>NAVIERA</th>
                                <th>ULTIMA NAVE</th>
                                <th>VIAJE</th>
                                <th>EXPORTADOR</th>
                                <th>COMMODITY</th>
                                <th>SETPOINT</th>
                                <th>PUERTO ORIGEN</th>
                                <th>PUERTO DESTINO</th>
                                <th>ETA</th>
                                <th>N° CONTENEDOR</th>
                                <th>CONTROLADOR</th>
                                <th>MODEM</th>
                                <th>FECHA SERVICIO</th>
                                <th>ESTADO SERVICIO</th>
                                <th>TEMPERATURA</th>
                                <th>ID SERVICIO</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="row">
                    <div class="col-lg-4">
                        <form class="form-inline">
                            <div class="form-group">
                                <label for="IdServicio" class="control-label tr" key="idsolicitud">ID SERVICIO</label>
                                <input type="text" class="form-control" id="IdServicio" disabled="disabled" style="text-align:center; text-align-last:center;" />
                                <input type="text" class="form-control" id="EstadoAprobacion" disabled="disabled" style="text-align:center; text-align-last:center; display:none;" />

                            </div>
                        </form>
                    </div>
                </div>
                <div class="divider"></div>
                <div class="row">
                    <div class="col-lg-11 col-lg-offset-1">
                        <button type="button" class="btn btn-primary tr" id="AprobarServicios" style="margin-bottom: 0px;">Aprobar Servicios</button>
                        <button type="button" class="btn btn-info tr" id="DesaprobarServicios" style="margin-bottom: 0px;">Desaprobar Servicios</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal7" id="GraficoUnitarioModal" style="display:none;"></button>

<!--Modal Grafico-->
<div class="modal fade" id="myModal7" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" style="margin-left:80px; margin-right:10px; ">
    <div class="modal-dialog" role="document" style="width:100%;">
        <div class="modal-content">
            <div class="modal-body">
                <iframe id="Grafico" width="100%" height="500px"></iframe>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger cerrarmodalGrafico" data-dismiss="modal">Cerrar</button>
            </div>
        </div>500
    </div>
</div>
<!--Modal Grafico-->

<script src="~/build/js/Perfiles.js"></script>
<script type="text/javascript">

    $(document).ready(function () {

        $('#Tb_Servicios thead tr:eq(1) th').each(function (i) {
            var title = $('#Tb_Servicios thead tr:eq(0) th').eq($(this).index()).text();
            if ($(this).index() != 0) {
                $(this).html('<input type="text" class="form-control" placeholder="FILTER" data-index="' + i + '"/>');
            }
        });

        var table = $("#Tb_Servicios").DataTable({
            orderCellsTop: true,
            scrollX: true,
            order: false,
            ajax: {
                "url": "@Url.Action("GetServiciosLegal", "Reservas")",
                "dataSrc": ''
            },
            columnDefs: [{
                "targets": 0,
                "defaultContent": "<i class='fa fa-search fa-2x' title='Ver Gráfico'></i>",
            }],
            columns: [
                {
                    "data": null,
                },
                {
                    "data": "EstadoAprobacion",
                    "render":
                      function (data, type, row, meta) {
                          if (data == 2) {
                              return "PENDIENTE APROBACION";
                          } else if (data == 1) {
                              return "APROBADO";
                          } else {
                              return "DESAPROBADO";
                          }
                      }
                },
                {
                    "data": "FechaAprobacion",
                    "render":
                    function (data, type, row, meta) {
                        if (data != null) {
                            var fecha = FormatDateControlador(data);
                            return fecha;
                        } else {
                            return "";
                        }
                    }
                },
                { "data": "Booking" },
                { "data": "Naviera" },
                { "data": "UltimaNave" },
                { "data": "Viaje" },
                { "data": "Exportador" },
                { "data": "Commodity" },
                { "data": "Setpoint"},
                { "data": "PuertoOrigen" },
                { "data": "PuertoDestino" },
                 {
                     "data": "EtaPuerto",
                     "render":
                     function (data, type, row, meta) {
                         if (data != null) {
                             var fecha = FormatDateControlador(data);
                             return fecha;
                         } else {
                             return "";
                         }
                     }
                 },
                { "data": "Contenedor" },
                { "data": "Controlador" },
                { "data": "Modem" },
                {
                    "data": "FechaControlador",
                    "render":
                    function (data, type, row, meta) {
                        if (data != null) {
                            var fecha = FormatDateControlador(data);
                            return fecha;
                        } else {
                            return "";
                        }
                    }
                },

                {"data": "EstadoServicio"},
                { "data": "Temperatura" },
                { "data": "IdServicio" },
            ]
        });

        $('#Tb_Servicios tbody').on('click', 'i', function () {
            var data = table.row($(this).parents('tr')).data();
            if (data["FechaControlador"] != null) {
                document.getElementById("Grafico").src = "http://132.255.70.203/GraficoCliente/Grafico.php?Controller=" + data["Controlador"] + "&Fecha=" + FormatDateControlador(data["FechaControlador"]);
            } else {
                document.getElementById("Grafico").src = "http://132.255.70.203/GraficoCliente/GraficoLegal.php?Controller=" + data["Controlador"] + "&Fecha=" + FormatDateControlador(data["FechaAprobacion"]);
            }
            $('#GraficoUnitarioModal').trigger('click');
        });

        $('#Tb_Servicios tbody').on('click', 'tr', function () {
            if ($(this).hasClass('selected')) {
                $("#IdServicio").val("");
                $("#EstadoAprobacion").val("");
                $(this).removeClass('selected');
            }
            else {
                table.$('tr.selected').removeClass('selected');
                $("#IdServicio").val(this.children[19].innerText);
                $("#EstadoAprobacion").val(this.children[1].innerText);
                $(this).addClass('selected');
            }
        });


        $(table.table().container()).on('keyup', 'thead input', function () {
            table
                .column($(this).data('index'))
                .search(this.value)
                .draw();
        });
    });


        function FormatDateControlador(data) {
            var dateString = data.substr(6);
            var currentTime = new Date(parseInt(dateString));
            var month = currentTime.getMonth() + 1;
            var day = currentTime.getDate();
            var year = currentTime.getFullYear();
            var Hora = currentTime.getHours();
            var Minutos = currentTime.getMinutes();

            if (month < 10) {
                month = "0" + month;
            } else {
                month;
            }

            if (day < 10) {
                day = "0" + day;
            } else {
                day;
            }

            if (Hora < 10 && Hora != 0) {
                Hora = "0" + Hora;
            } else if(Hora == 0) {
                Hora = "00";
            }else {
                Hora;
            }

            if (Minutos < 10 && Minutos != 0) {
                Minutos = "0" + Minutos;
            } else if(Minutos == 0) {
                Minutos = "00" ;
            }else {
                Minutos;
            }

            var date = day + "-" + month + "-" + year + " " + Hora + ":" + Minutos;
            return date;
        }


        $("#AprobarServicios").click(function () {
            if ($("#IdServicio").val() != "") {
                    $.ajax({
                        type: "POST",
                        url: '@Url.Action("AprobarServicio", "Reservas")',
                        data: { Servicio: $("#IdServicio").val() },
                        success: function (response) {
                            var json = JSON.parse(response);
                            if (json.validador == 0) {
                                var aux = 'success';
                            } else {
                                var aux = 'warning';
                            }
                            swal({
                                title: '',
                                text: json.Mensaje,
                                type: aux,
                                showCancelButton: false,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Aceptar'
                            }).then((result) => {
                                $('#Tb_Servicios').DataTable().ajax.reload();
                            })
                        }
                    });
            } else {
                swal('Ups!', '<span class="alerta" key="errorsolicitudcancelar">Debes seleccionar un servicio para que sea desaprobado.</span>', 'error');
            }
        });

        $("#DesaprobarServicios").click(function () {
            if ($("#IdServicio").val() != "") {
                if ($("#EstadoAprobacion").val() != "DESAPROBADO") {
                    $.ajax({
                        type: "POST",
                        url: '@Url.Action("DesaprobarServicio", "Reservas")',
                        data: { Servicio: $("#IdServicio").val() },
                        success: function (response) {
                            var json = JSON.parse(response);
                            if (json.validador == 0) {
                                var aux = 'success';
                            } else {
                                var aux = 'warning';
                            }
                            swal({
                                title: '',
                                text: json.Mensaje,
                                type: aux,
                                showCancelButton: false,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Aceptar'
                            }).then((result) => {
                                $('#Tb_Servicios').DataTable().ajax.reload();
                            })
                        }
                    });
                } else {
                    swal('Ups!', '<span class="alerta" key="errorsolicitudcancelar">No puedes desaprobar un servicio ya desaprobado</span>', 'error');
                }
            } else {
                swal('Ups!', '<span class="alerta" key="errorsolicitudcancelar">Debes seleccionar un servicio para que sea aprobado.</span>', 'error');
            }
        });

</script>


