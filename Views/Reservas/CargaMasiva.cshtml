
@{
    ViewBag.Title = "CargaMasiva";
    Layout = "~/Views/MasterPage.cshtml";
}


<div class="col-md-12 col-sm-12 col-xs-12">
    <div class="x_panel">
        <div class="x_title">
            <h2>Carga Masiva de Reservas de Servicios<small></small></h2>
            <div class="clearfix"></div>
        </div>
        <br />
        <br />
        <div class="x_content">
            <div class="x_panel">
                <div class="col-lg-12 col-md-12 col-sm-12 form-group">
                    <div class="col-lg-3 col-md-3 col-sm-3">
                        <label class="control-label tr" key="cargamasivaingreso">Carga masiva reservas</label>
                    </div>
                    <div class="col-lg-3 col-md-3 col-sm-3">
                        <input type="file" id="ArchivoCargaMasiva" name="Archivo" placeholder="Suba Archivo Excel" class="form-control">
                    </div>

                    <div class="col-lg-1 col-md-1 col-sm-1">
                        <a title="Subir Archivo" id="SubirArchivoCarga" name="SubirArchivoCarga" class="SubirArchivoCarga"><i class="fa fa-upload fa-2x"></i></a>
                    </div>
                </div>
            </div>
            <div class="x_panel" id="Tablareservas" style="display:none;">
                <table id="Tb_ReservaMasiva" class="table table-striped table-bordered display nowrap" hidden="hidden">
                    <thead>
                        <tr>
                            <th class="tr" key="operaciontablareserva">NAVE</th>
                            <th class="tr" key="fechatablareserva">VIAJE</th>
                            <th class="tr" key="usuariotablareserva">ETA</th>
                            <th class="tr" key="observaciontablareserva">INICIO STACKING</th>
                            <th class="tr" key="observaciontablareserva">TERMINO STACKING</th>
                            <th class="tr" key="observaciontablareserva">ETD</th>
                            <th class="tr" key="observaciontablareserva">NAVIERA</th>
                            <th class="tr" key="observaciontablareserva">FREIGHT FORWARDER</th>
                            <th class="tr" key="observaciontablareserva">EXPORTADOR</th>
                            <th class="tr" key="observaciontablareserva">PUERTO EMBARQUE</th>
                            <th class="tr" key="observaciontablareserva">PUERTO DESTINO</th>
                            <th class="tr" key="observaciontablareserva">BOOKING</th>
                            <th class="tr" key="observaciontablareserva">CANTIDAD SERVICIOS</th>
                            <th class="tr" key="observaciontablareserva">COMMODITY</th>
                            <th class="tr" key="observaciontablareserva">CO2</th>
                            <th class="tr" key="observaciontablareserva">O2</th>
                            <th class="tr" key="observaciontablareserva">TEMPERATURA</th>
                            <th class="tr" key="observaciontablareserva">CONSIGNATARIO</th>
                        </tr>
                    </thead>
                </table>
            </div> 
                    
                <div class="divider"></div>
                <div class="form-group">
                    <div class="col-md-12 col-sm-12 col-xs-12" style="text-align:center">
                        <button id="GuardarMasiva" type="button" class="btn btn-success tr" key="botonguardarservicio">Guardar</button>
                        <button class="btn btn-warning tr" key="limpiar" type="reset">Limpiar</button>
                    </div>
                </div>
        </div>
    </div>
</div>


<script src="~/build/js/Perfiles.js"></script>
<script type="text/javascript">

    var lenguaje = document.cookie;

    function formatDate(date) {
        var fecha = date.substring(0, 10);
        var ano = date.substring(0, 4);
        var mes = date.substring(5, 7);
        var dia = date.substring(8, 10);
        return dia + "/" + mes + "/" + ano;
    }


    $(".SubirArchivoCarga").click(function () {
        if ($('#ArchivoCargaMasiva').val() != "") {

            $("#ArchivoCargaMasiva").css("background", "rgba(255, 0, 0, 0)");
            var fileUpload = document.getElementById("ArchivoCargaMasiva");
            if (fileUpload.value != null) {
                var uploadFile = new FormData();
                var files = $("#ArchivoCargaMasiva").get(0).files;
                // Add the uploaded file content to the form data collection
                if (files.length > 0) {
                    uploadFile.append("Controladores", files[0]);
                    $.ajax({
                        url: '@Url.Action("LeerCargaMasiva", "Reservas")',
                        contentType: false,
                        processData: false,
                        data: uploadFile,
                        type: 'POST',
                        async: false,
                        success: function (response) {
                            var data = [];
                            var json = JSON.parse(response);
                            var cuenta = json.length;
                            if (cuenta != 0) {
                                if (json == "Error de Datos") {
                                    swal('Ups!', '<span> Error de Datos.</span>', 'error');
                                    return false;
                                } else if (json == "Error de Formato") {
                                    swal('Ups!', '<span> Error de Formato.</span>', 'error');
                                    return false;
                                } else {
                                    var flag = 0;
                                    for (var i = 0 ; i < cuenta ; i++) {
                                        $.ajax({
                                            type: "POST",
                                            url: '@Url.Action("ValidarMantenedoresMasiva", "Reservas")',
                                            async: false,
                                            data: {
                                                Naviera: json[i].Naviera,
                                                Exportador: json[i].Exportador,
                                                PuertoOrigen: json[i].PuertoOrigen,
                                                PuertoDestino: json[i].PuertoDestino,
                                                Commodity: json[i].Commodity
                                            },
                                            success: function (response) {
                                                var json2 = JSON.parse(response);
                                                if (json2.validador == 0) {
                                                    var aux = 'warning';
                                                    swal({
                                                        title: '',
                                                        text: json2.Mensaje,
                                                        type: aux,
                                                        showCancelButton: false,
                                                        confirmButtonColor: '#3085d6',
                                                        cancelButtonColor: '#d33',
                                                        confirmButtonText: 'Aceptar'
                                                    }).then((result) => {
                                                        flag = 0;
                                                    })
                                                }else
                                                {
                                                    flag = 1;
                                                    var eta = formatDate(json[i].Eta);
                                                    var etd = formatDate(json[i].Etd);

                                                    if (json[i].FechaIniStacking == null) {
                                                        var inicioStacking = "";
                                                    } else {
                                                        var inicioStacking = formatDate(json[i].FechaIniStacking);
                                                    }

                                                    if (json[i].FechaFinStacking == null) {
                                                        var finStacking = "";
                                                    } else {
                                                        var finStacking = formatDate(json[i].FechaFinStacking);
                                                    }

                                                    data.push([json[i].Nave,
                                                    json[i].Viaje,
                                                    eta, inicioStacking,
                                                    finStacking, etd,
                                                    json[i].Naviera,
                                                    json[i].FreightForwarder,
                                                    json[i].Exportador,
                                                    json[i].PuertoOrigen,
                                                    json[i].PuertoDestino,
                                                    json[i].Booking,
                                                    json[i].CantidadServicios,
                                                    json[i].Commodity,
                                                    json[i].CO2Setpoint,
                                                    json[i].O2Setpoint,
                                                    json[i].Temperatura,
                                                    json[i].Consignatario]);
                                                }
                                            }
                                        }); 
                                    }
                                    if (flag == 1)
                                    {
                                        var tableReservas = $('#Tb_ReservaMasiva').DataTable();
                                        tableReservas.destroy();
                                        var tableReservas = $('#Tb_ReservaMasiva').DataTable({
                                            data: data,
                                        });
                                        $("#Tablareservas").show();
                                        $("#Tb_ReservaMasiva").show();
                                    }
                                   
                                }
                            }
                        }
                    });
                }
            }
        } else {
            $("#ArchivoCargaMasiva").css("background", "rgba(255, 0, 0, 0.4)");
        }
    });

    $("#GuardarMasiva").click(function () {
        var tableReservas = $('#Tb_ReservaMasiva').DataTable();
        var InfoReservas = tableReservas.rows().data();
        if (InfoReservas.length != 0) {
            for (var i = 0; i < InfoReservas.length ; i++) {
                $.ajax({
                    type: "POST",
                    url: '@Url.Action("AgregarReservasMasiva", "Reservas")',
                    data: {
                        Nave: InfoReservas[i][0],
                        Viaje: InfoReservas[i][1],
                        Eta: InfoReservas[i][2],
                        FechaIniStacking: InfoReservas[i][3],
                        FechaFinStacking: InfoReservas[i][4],
                        Etd: InfoReservas[i][5],
                        Naviera: InfoReservas[i][6],
                        FreightForwarder: InfoReservas[i][7],
                        Exportador: InfoReservas[i][8],
                        PuertoOrigen: InfoReservas[i][9],
                        PuertoDestino: InfoReservas[i][10],
                        Booking: InfoReservas[i][11],
                        CantidadServicios: InfoReservas[i][12],
                        Commodity: InfoReservas[i][13],
                        CO2: InfoReservas[i][14],
                        O2: InfoReservas[i][15],
                        Temperatura: InfoReservas[i][16],
                        Consignatario: InfoReservas[i][17]
                    },
                    success: function (response) {
                        var json = JSON.parse(response);
                        if (json.validador == 0) {
                            var aux = 'success';
                        } else {
                            var aux = 'warning';
                        }
                        swal({
                            title: '',
                            text: json.Mensaje,
                            type: aux,
                            showCancelButton: false,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'Aceptar'
                        }).then((result) => {
                            location.reload();
                        })
                    }
                });
            }
        } else {
            $("#Tablareservas").hide();
            swal('Ups!', '<span class="alerta" key="errorcontroladoreslogistica">No se han cargado datos</span>', 'error');
        }
    });
</script>