
@{
    ViewBag.Title = "VisualizarBaterias";
    Layout = "~/Views/MasterPage.cshtml";
    int PerfilInterior = Convert.ToInt32(Session["PerfilInterior"]);
    string Usuario = Session["User"].ToString().ToUpper();
}

<div class="col-sm-12">
    <div class="x_panel">
        <div class="x_title">
            <div class="row">
                <div class="col-sm-7">
                    <h2 class="tr" key="titulobaterias">Alertas En Tránsito</h2>
                </div>
            </div>
            <div class="clearfix"></div>
        </div>

        <div class="x_content">
            <div class="x_panel">
                <div class="row">

                    <div class="col-sm-12 col-md-12 col-lg-12" id="tablaAlertas">
                        <table id="Tb_Alertas" class="table table-striped table-bordered display nowrap">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th class="tr" key="idAlerta">ID ALERTA</th>
                                    <th class="tr" key="descripcionAlerta">DESCRIPCIÓN ALERTA</th>
                                    <th class="tr" key="fechaAlerta">FECHA</th>
                                    <th class="tr" key="idServicio">ID SERVICIO</th>
                                    <th class="tr" key="controlador">CONTROLADOR</th>
                                    <th class="tr" key="modem">MODEM</th>
                                    <th class="tr" key="activa">ACTIVA</th>
                                </tr>
                                <tr>
                                    <th></th>
                                    <th class="tr" key="idAlerta">ID ALERTA</th>
                                    <th class="tr" key="descripcionAlerta">DESCRIPCIÓN ALERTA</th>
                                    <th class="tr" key="fechaAlerta">FECHA</th>
                                    <th class="tr" key="idServicio">ID SERVICIO</th>
                                    <th class="tr" key="controlador">CONTROLADOR</th>
                                    <th class="tr" key="modem">MODEM</th>
                                    <th class="tr" key="activa">ACTIVA</th>
                                </tr>
                            </thead>
                            <tfoot>
                                <tr>
                                    <th></th>
                                    <th class="tr" key="idAlerta">1. ID ALERTA</th>
                                    <th class="tr" key="descripcionAlerta">2. DESCRIPCIÓN ALERTA</th>
                                    <th class="tr" key="fechaAlerta">3. FECHA</th>
                                    <th class="tr" key="idServicio">4. ID SERVICIO</th>
                                    <th class="tr" key="controlador">5. CONTROLADOR</th>
                                    <th class="tr" key="modem">6. MODEM</th>
                                    <th class="tr" key="activa">7. ACTIVA</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                </div>
                <div class="row" id="botonesacciones">
                    <div class="col-lg-11 col-lg-offset-1">
                        <button type="button" class="btn btn-success tr btn-sm" key="ActivarDesactivarAlerta" id="ActivarDesactivarAlerta">Activar/Desactivar Alertas</button>
                    </div>
                </div>

            </div>
        </div>
    </div>


    <script src="~/build/js/Perfiles.js"></script>

    <script type="text/javascript">

        var lenguaje = document.cookie;

        function formatDate(date) {
            if (date != null) {
                var fecha = date.substring(0, 10);
                var ano = date.substring(0, 4);
                var mes = date.substring(5, 7);
                var dia = date.substring(8, 10);
                return dia + "-" + mes + "-" + ano;
            } else {
                return "";
            }
        }

        function FormatDate(data) {
            var dateString = data.substr(6);
            var currentTime = new Date(parseInt(dateString));
            var month = currentTime.getMonth() + 1;
            var day = currentTime.getDate();
            var year = currentTime.getFullYear();

            if (month < 10) {
                month = "0" + month;
            } else {
                month;
            }

            if (day < 10) {
                day = "0" + day;
            } else {
                day;
            }

            var date = day + "-" + month + "-" + year;
            return date;
        }

        function FormatDateControlador(data) {
            var dateString = data.substr(6);
            var currentTime = new Date(parseInt(dateString));
            var month = currentTime.getMonth() + 1;
            var day = currentTime.getDate();
            var year = currentTime.getFullYear();
            var Hora = currentTime.getHours();
            var Minutos = currentTime.getMinutes();

            if (month < 10) {
                month = "0" + month;
            } else {
                month;
            }

            if (day < 10) {
                day = "0" + day;
            } else {
                day;
            }

            if (Hora < 10 && Hora != 0) {
                Hora = "0" + Hora;
            } else if (Hora == 0) {
                Hora = "00";
            } else {
                Hora;
            }

            if (Minutos < 10 && Minutos != 0) {
                Minutos = "0" + Minutos;
            } else if (Minutos == 0) {
                Minutos = "00";
            } else {
                Minutos;
            }

            var date = day + "-" + month + "-" + year + " " + Hora + ":" + Minutos;
            return date;
        }



        $(document).ready(function () {

            $('#Tb_Alertas thead tr:eq(1) th').each(function (i) {
                var title = $('#example thead tr:eq(0) th').eq( $(this).index() ).text();
                if($(this).index() != 0){
                    $(this).html( '<input type="text" class="form-control" placeholder="FILTER" data-index="'+i+'"/>' );
                }
            });

            var table = $("#Tb_Alertas").DataTable({
                initComplete: function () {
                    this.api().columns().every(function () {
                        var column = this;
                        if (column.index() == 2) {
                            //alert(column.index());

                            var select = $('<select><option value=""></option></select>')
                                .appendTo($(column.footer()).empty())
                                .on('change', function () {
                                    var val = $.fn.dataTable.util.escapeRegex(
                                        $(this).val()
                                    );

                                    column
                                        .search(val ? '^' + val + '$' : '', true, false)
                                        .draw();
                                });

                            column.data().unique().sort().each(function (d, j) {
                                select.append('<option value="' + d + '">' + d + '</option>')
                            });
                        }
                    });
                },
                orderCellsTop:  true,
                fixedColumns:   true,
                scrollX: true,
                pageLength: 15,
                ajax: {
                    "url": "@Url.Action("GetAlertasEnTransito", "Alertas")",
                    "dataSrc": ''
                },
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'excel',
                        exportOptions: {
                            columns: [0, 1, 2, 3, 4, 5, 6],
                            orthogonal: 'export'
                        },
                    }
                ],
            columns: [
                { "data": "Checkbox" },
                { "data": "Id" },
                { "data": "Descripcion" },
                {
                    "data": "Fecha",
                    "render":
                      function (data, type, row, meta) {
                          if (data != null) {
                              var fecha = FormatDateControlador(data);
                              return fecha;
                          } else {
                              return "";
                          }
                      }
                },
                { "data": "IdServicio" },
                { "data": "Controlador" },
                { "data": "Modem" },
                {
                    "data": "Activo",
                    "render":
                    function (data, type, row, meta) {
                        if (data == 1) {
                            return "SI";
                        } else {
                            return "NO";
                        }
                    }
                },
            ],
            columnDefs: [
                {
                    'targets': 0,
                    'checkboxes': {
                        'selectRow': true
                    }
                }
            ],
            select: {
                'style': 'multi'
            },
            });

            $( table.table().container() ).on('keyup', 'thead input', function () {
                table
                    .column( $(this).data('index'))
                    .search( this.value )
                    .draw();
            });

            $('#example-select-all').on('click', function(){
                // Get all rows with search applied
                var rows = table.rows({ 'search': 'applied' }).nodes();
                // Check/uncheck checkboxes for all rows in the table
                $('input[type="checkbox"]', rows).prop('checked', this.checked);
            });

        });

        //EDITAR RESERVA
        $("#ActivarDesactivarAlerta").click(function () {
            var count = 0;
            var cuenta = $("#Tb_Alertas tbody tr").length;
            var Alertas = [];

            $("#Tb_Alertas tbody tr").each(function () {
                if ($(this).find(".dt-checkboxes").is(":checked")) {
                    count = count + 1;
                    Alertas.push($(this).find("td:eq(1)").html());
                }
            });



            console.log('cuenta: ' + cuenta);
            console.log('count: ' + count);
            console.log(Alertas);

            if (count > 0)
            {
                if (count > 1) {
                    swal('Ups!', 'No puedes activar/desactivar mas de una alerta a la vez', 'error');
                    return false;
                } else {

                    swal({
                        title: 'Advertencia',
                        text: '¿Estas seguro que deseas activar/desactivar la alerta?',
                        type: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Aceptar'
                    }).then((result) => {
                        localStorage.setItem("Lista1", JSON.stringify(Alertas));
                        var Lista = JSON.parse(localStorage.getItem("Lista1"));
                        $.ajax({
                            type: "POST",
                            url: '@Url.Action("ActivarDesactivarAlertas", "Alertas")',
                            data: {
                                lista_alertas: Lista
                            },
                            success: function (response) {

                                var json = JSON.parse(response);
                                console.log('json: ' + json);

                                swal({
                                    title: json.titulo_mensaje,
                                    text: json.Mensaje,
                                    type: json.tipo_mensaje,
                                    showCancelButton: false,
                                    confirmButtonColor: '#3085d6',
                                    cancelButtonColor: '#d33',
                                    confirmButtonText: 'Aceptar'
                                }).then((result) => {
                                    location.reload();
                                })
                            }
                        });
                    })
                }
            }
            else
            {
                swal('Ups!', 'Debe seleccionar al menos un registro.', 'error');
                return false;
            }
        });
        //EDITAR RESERVA

    </script>


